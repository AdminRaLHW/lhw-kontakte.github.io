<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontakte | Lebenshilfswerk Waren</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root {
            --bg-opacity: 0.1;
            --card-min-width: 350px;
            --bg-body: #f4f7f9;
            --bg-panel: #ffffff;
            --text-main: #2c3e50;
            --text-muted: #64748b;
            --border-ui: #e2e8f0;

            /* Category Colors */
            --hex-01: #81c784; --hex-02: #81c784; --hex-03: #ffa726;
            --hex-04: #ffa726; --hex-05: #4fc3f7; --hex-06: #1976d2;
            --hex-07: #1a237e; --hex-08: #00897b; --hex-09: #2e7d32;
            --hex-10: #8e24aa; --hex-11: #c2185b; --hex-12: #fbc02d;
            --hex-13: #d84315;
            --accent: #455a64; 
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border-ui: #334155;
            --bg-opacity: 0.15;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            padding: 20px; margin: 0; background: var(--bg-body); color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        /* --- NAVIGATION BAR --- */
        .no-print {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            padding: 15px 25px;
            background: var(--bg-panel);
            border-radius: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--border-ui);
        }

        .main-controls {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1 1 500px;
            min-width: 0;
        }

        .logo-link {
            display: flex; align-items: center; flex-shrink: 0; transition: opacity 0.2s;
        }
        .logo-link:hover { opacity: 0.8; }
        .logo-link:focus { outline: 3px solid var(--accent); outline-offset: 5px; border-radius: 4px; }
        .logo { height: 45px; width: auto; }

        .search-wrapper { flex-grow: 1; min-width: 150px; }
        input {
            width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-ui);
            background: var(--bg-body); color: var(--text-main); font-size: 1rem;
            outline: none; transition: border-color 0.2s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px hsl(from var(--accent) h s l / 0.2); }

        .action-controls { display: flex; gap: 10px; flex: 1 0 auto; }

        .theme-btn, .print-btn {
            flex: 1; min-width: 130px; display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 11px 18px; border-radius: 8px; border: 1px solid var(--border-ui); 
            background: var(--bg-panel); color: var(--text-main); cursor: pointer; 
            font-weight: 600; font-size: 0.9rem; transition: all 0.2s; white-space: nowrap;
        }

        .theme-btn:hover, .print-btn:hover { background: var(--bg-body); border-color: var(--text-muted); }
        .btn-icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2.2; }

        .update-hint {
            text-align: right; font-size: 0.75rem; color: var(--text-muted);
            margin-bottom: 30px; padding-right: 10px; font-style: italic;
        }

        /* --- HIERARCHIE-STYLING --- */
        .bereich-section { margin-bottom: 50px; }
        
        .bereich-header { 
            font-size: 1.5rem; text-transform: uppercase; margin-bottom: 25px; 
            padding-bottom: 10px; border-bottom: 3px solid var(--border-ui);
            letter-spacing: 0.05em; color: var(--text-main);
        }

        .abteilung-group { margin-bottom: 35px; padding-left: 5px; }

        .abteilung-header {
            font-size: 1.15rem; color: var(--text-muted); margin: 0 0 15px 0;
            display: flex; align-items: center; gap: 10px; font-weight: 600;
        }
        .abteilung-header::before {
            content: ""; width: 15px; height: 2px; background: var(--accent); opacity: 0.5;
        }

        .cards-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--card-min-width), 1fr)); gap: 20px; 
        }

        /* --- KONTAKTKARTE --- */
        .contact-card {
            background-color: hsl(from var(--accent) h s l / var(--bg-opacity));
            border-left: 6px solid var(--accent);
            padding: 20px; border-radius: 10px; display: flex; flex-direction: column;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.2s ease;
        }
        .contact-card:hover { transform: translateY(-3px); }
        .contact-card h4 { margin: 0 0 5px 0; font-size: 1.2rem; }
        .job-position { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; margin-bottom: 15px; }
        .contact-row { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .icon-container { width: 18px; height: 18px; flex-shrink: 0; color: var(--accent); }
        
        .contact-link {
            text-decoration: none; color: inherit; font-size: 0.95rem;
            transition: color 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .contact-link:hover, .contact-link:focus { color: var(--accent); text-decoration: underline; outline: none; }

        .cat-01 { --accent: var(--hex-01); } .cat-02 { --accent: var(--hex-02); }
        .cat-03 { --accent: var(--hex-03); } .cat-04 { --accent: var(--hex-04); }
        .cat-05 { --accent: var(--hex-05); } .cat-06 { --accent: var(--hex-06); }
        .cat-07 { --accent: var(--hex-07); } .cat-08 { --accent: var(--hex-08); }
        .cat-09 { --accent: var(--hex-09); } .cat-10 { --accent: var(--hex-10); }
        .cat-11 { --accent: var(--hex-11); } .cat-12 { --accent: var(--hex-12); }
        .cat-13 { --accent: var(--hex-13); }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }

        @media print {
            .no-print, .update-hint { display: none !important; }
            body { background: white !important; padding: 0; }
            .bereich-section { break-inside: avoid-page; }
            .contact-card { background: white !important; border: 1px solid #ccc !important; border-left: 10px solid var(--accent) !important; break-inside: avoid; }
        }

        @media (max-width: 768px) { .main-controls, .action-controls { flex-basis: 100%; } }
    </style>
</head>
<body>

<header class="no-print">
    <div class="main-controls">
        <a href="https://lebenshilfswerk-waren.de" class="logo-link" aria-label="Zur Startseite des Lebenshilfswerks Waren">
            <img src="img/LHW Logo Trans.svg" alt="LHW Logo" class="logo">
        </a>
        <div class="search-wrapper">
            <label for="search" class="sr-only">Kontakte suchen</label>
            <input type="text" id="search" onkeyup="handleSearch()" placeholder="Suche nach Name, Bereich, Abteilung..." aria-controls="directory">
        </div>
    </div>
    
    <div class="action-controls">
        <button class="theme-btn" onclick="toggleTheme()" id="themeToggle" aria-live="polite">
            <svg id="sun-icon" class="btn-icon" style="display:none" viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>
            <svg id="moon-icon" class="btn-icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
            <span id="theme-text">Dunkel</span>
        </button>
        <button onclick="window.print()" class="print-btn" aria-label="Liste drucken">
            <svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2m-12 0v5h12v-5m-12-4h12"/></svg>
            Drucken
        </button>
    </div>
</header>

<div id="last-update" class="update-hint" aria-hidden="true"></div>

<main id="directory" aria-label="Kontaktverzeichnis"></main>

<script>
    const CSV_PATH = "data/kontakte.csv";

    async function fetchLastModified() {
        try {
            const response = await fetch(CSV_PATH, { method: 'HEAD' });
            const lastMod = response.headers.get("Last-Modified");
            if (lastMod) {
                const date = new Date(lastMod);
                document.getElementById('last-update').textContent = `Datenstand: ${date.toLocaleDateString('de-DE')}`;
            }
        } catch (e) { console.warn("Datum nicht verfügbar."); }
    }
    fetchLastModified();

    const ICON_PHONE = `<svg class="btn-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>`;
    const ICON_MOBILE = `<svg class="btn-icon" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>`;
    const ICON_MAIL = `<svg class="btn-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;

    function toggleTheme() {
        const theme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        applyTheme(theme);
    }

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('dir-theme', theme);
        const isDark = theme === 'dark';
        document.getElementById('sun-icon').style.display = isDark ? 'block' : 'none';
        document.getElementById('moon-icon').style.display = isDark ? 'none' : 'block';
        document.getElementById('theme-text').textContent = isDark ? 'Hell' : 'Dunkel';
    }
    applyTheme(localStorage.getItem('dir-theme') || 'light');

    /**
     * ERWEITERTE SUCHE: Inkludiert Bereiche und Abteilungen
     */
    function handleSearch() {
        const query = document.getElementById('search').value.toLowerCase();
        
        document.querySelectorAll('.bereich-section').forEach(bereichSec => {
            const bereichHeader = bereichSec.querySelector('.bereich-header').textContent.toLowerCase();
            const bereichMatch = bereichHeader.includes(query);

            let bereichHasVisibleContent = false;

            bereichSec.querySelectorAll('.abteilung-group').forEach(abtGrp => {
                const abtHeaderEl = abtGrp.querySelector('.abteilung-header');
                const abtHeaderText = abtHeaderEl ? abtHeaderEl.textContent.toLowerCase() : "";
                const abtMatch = abtHeaderText.includes(query);

                let abtHasVisibleContent = false;

                abtGrp.querySelectorAll('.contact-card').forEach(card => {
                    const cardText = card.textContent.toLowerCase();
                    const cardMatch = cardText.includes(query);

                    // Karte anzeigen wenn: Bereich matcht ODER Abteilung matcht ODER Karte selbst matcht
                    const isVisible = bereichMatch || abtMatch || cardMatch;
                    card.style.display = isVisible ? "" : "none";
                    
                    if (isVisible) abtHasVisibleContent = true;
                });

                // Abteilung anzeigen wenn Überschrift matcht ODER sichtbare Karten enthalten sind
                const showAbt = abtMatch || abtHasVisibleContent;
                abtGrp.style.display = showAbt ? "" : "none";
                if (showAbt) bereichHasVisibleContent = true;
            });

            // Bereich anzeigen wenn Überschrift matcht ODER sichtbare Abteilungen enthalten sind
            bereichSec.style.display = (bereichMatch || bereichHasVisibleContent) ? "" : "none";
        });
    }

    Papa.parse(CSV_PATH, {
        download: true, header: true, skipEmptyLines: true,
        complete: (results) => render(results.data)
    });

    function render(data) {
        const root = document.getElementById('directory');
        root.innerHTML = "";

        const areaSortMap = {}; 
        const groupedData = data.reduce((acc, p) => {
            const b = (p.Bereich && p.Bereich.trim() !== "") ? p.Bereich : "Allgemein";
            const a = (p.Abteilung && p.Abteilung.trim() !== "") ? p.Abteilung : "_NO_DEPT_";
            const currentCode = parseInt(p.ColorCode) || 99;
            if (!areaSortMap[b] || currentCode < areaSortMap[b]) areaSortMap[b] = currentCode;
            if (!acc[b]) acc[b] = {};
            if (!acc[b][a]) acc[b][a] = [];
            acc[b][a].push(p);
            return acc;
        }, {});

        const sortedBereiche = Object.keys(groupedData).sort((a, b) => areaSortMap[a] - areaSortMap[b]);

        sortedBereiche.forEach(bName => {
            const bereichSection = document.createElement('section');
            bereichSection.className = "bereich-section";
            bereichSection.innerHTML = `<h2 class="bereich-header">${bName}</h2>`;

            const sortedAbteilungen = Object.keys(groupedData[bName]).sort();

            sortedAbteilungen.forEach(aName => {
                const abtGroup = document.createElement('div');
                abtGroup.className = "abteilung-group";
                if (aName !== "_NO_DEPT_") abtGroup.innerHTML = `<h3 class="abteilung-header">${aName}</h3>`;
                const grid = document.createElement('div');
                grid.className = "cards-grid";

                groupedData[bName][aName].sort((x,y) => x.Name.localeCompare(y.Name)).forEach(p => {
                    const code = p.ColorCode ? p.ColorCode.toString().padStart(2, '0') : '01';
                    const card = document.createElement('div');
                    card.className = `contact-card cat-${code}`;
                    const createRow = (icon, val, type) => {
                        if (!val || val === "-") return "";
                        const link = type === 'tel' ? `tel:${val.replace(/\s/g, '')}` : `mailto:${val}`;
                        return `<div class="contact-row"><span class="icon-container">${icon}</span><a href="${link}" class="contact-link">${val}</a></div>`;
                    };
                    card.innerHTML = `<h4>${p.Name}</h4><div class="job-position">${p.Position || ''}</div>${createRow(ICON_PHONE, p.Telefon, 'tel')}${createRow(ICON_MOBILE, p.Mobiltelefon, 'tel')}${createRow(ICON_MAIL, p.Email, 'mail')}`;
                    grid.appendChild(card);
                });
                abtGroup.appendChild(grid);
                bereichSection.appendChild(abtGroup);
            });
            root.appendChild(bereichSection);
        });
    }
</script>
</body>
</html>