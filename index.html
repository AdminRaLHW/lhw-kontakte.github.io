<!DOCTYPE html>
<html lang="de" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontakte | Lebenshilfswerk Waren</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root {
            /* UI MONOCHROM (Light) */
            --bg-body: #f2f2f2;
            --bg-panel: #ffffff;
            --text-main: #000000;
            --text-muted: #555555;
            --border-ui: #cccccc;
            --bg-opacity-area: 0.1;
            
            /* Card Settings */
            --card-bg: #ffffff;
            --card-text: #1a1a1a;
            --card-text-muted: #555555;
            --card-min-width: 350px;

            /* Category HEX Colors */
            --hex-01: #81c784; --hex-02: #81c784; --hex-03: #ffa726;
            --hex-04: #ffa726; --hex-05: #4fc3f7; --hex-06: #1976d2;
            --hex-07: #1a237e; --hex-08: #00897b; --hex-09: #2e7d32;
            --hex-10: #8e24aa; --hex-11: #c2185b; --hex-12: #fbc02d;
            --hex-13: #d84315;
            --accent: #444444; 

            /* Accessibility Defaults */
            --acc-font-scale: 1;
        }

        [data-theme="dark"] {
            --bg-body: #0a0a0a;
            --bg-panel: #2a2a2a;
            --text-main: #ffffff;
            --text-muted: #bbbbbb;
            --border-ui: #555555;
            --bg-opacity-area: 0.25;
            --card-bg: #ffffff;
            --card-text: #000000;
            --card-text-muted: #444444;
        }

        html {
            /* Dynamische Schriftgröße basierend auf Skala */
            font-size: calc(16px * var(--acc-font-scale));
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            padding: 0; margin: 0; background: var(--bg-body); color: var(--text-main);
            transition: background 0.3s, color 0.3s;
        }

        /* Container für den Inhalt, damit Filter den FAB-Button nicht beeinflussen */
        #app-wrapper {
            padding: 20px;
            transition: filter 0.3s;
        }

        /* Accessibility Filter (Nur auf Wrapper) */
        .acc-grayscale #app-wrapper { filter: grayscale(1) !important; }
        .acc-invert #app-wrapper { filter: invert(1) hue-rotate(180deg) !important; }
        .acc-high-contrast #app-wrapper { background: #000 !important; color: #fff !important; }
        .acc-high-contrast .contact-card { background: #000 !important; border: 2px solid #fff !important; color: #fff !important; }
        .acc-high-contrast .contact-link, .acc-high-contrast h4 { color: #fff !important; }
        .acc-high-contrast .bereich-section { background: #111 !important; border: 1px solid #fff !important; }

        .print-only { display: none; }

        /* --- HEADER --- */
        .no-print {
            display: flex; flex-wrap: wrap; gap: 20px; align-items: center; 
            padding: 15px 25px; background: var(--bg-panel); border-radius: 12px;
            margin-bottom: 8px; border: 1px solid var(--border-ui);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        
        [data-theme="dark"] input { background: #1a1a1a; border-color: #666666; }

        .main-controls { display: flex; align-items: center; gap: 20px; flex: 1 1 500px; min-width: 0; }
        .logo { height: 45px; width: auto; filter: grayscale(1); transition: filter 0.3s; }
        [data-theme="dark"] .logo { filter: grayscale(1) invert(1); }
        .logo-link:hover .logo { filter: grayscale(0) invert(0); }

        .search-wrapper { flex-grow: 1; min-width: 150px; }
        input {
            width: 100%; padding: 12px 16px; border-radius: 8px; border: 1px solid var(--border-ui);
            background: var(--bg-body); color: var(--text-main); font-size: 1rem; outline: none;
        }

        .action-controls { display: flex; gap: 10px; flex: 1 0 auto; }
        .theme-btn, .print-btn {
            flex: 1; min-width: 130px; display: flex; align-items: center; justify-content: center; gap: 8px; 
            padding: 11px 18px; border-radius: 8px; border: 1px solid var(--border-ui); 
            background: var(--bg-panel); color: var(--text-main); cursor: pointer; font-weight: 600;
        }
        .update-hint { text-align: right; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 30px; padding-right: 10px; font-style: italic; }

        /* --- WEB FOOTER --- */
        .web-footer {
            max-width: 100%; 
            margin-top: 80px; 
            padding: 25px 40px; 
            border-top: 1px solid var(--border-ui);
            display: flex; 
            justify-content: space-between; 
            align-items: flex-start; 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            background: var(--bg-panel);
        }

        /* --- BEREICHS-STYLING --- */
        .bereich-section { 
            margin-bottom: 50px; border-radius: 16px;
            background-color: hsl(from var(--accent) h s l / var(--bg-opacity-area));
            border: 1px solid var(--border-ui); overflow: hidden;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        
        .bereich-header { 
            font-size: 1.4rem; text-transform: uppercase; margin: 0; padding: 18px 25px; 
            background-color: var(--accent); color: #ffffff;
            letter-spacing: 0.08em; font-weight: 800;
        }

        .bereich-content { padding: 25px; }
        .abteilung-group { margin-bottom: 35px; }
        .abteilung-location {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: -10px 0 15px 0; /* Zieht es näher an den Header ran */
            font-style: italic;
            font-weight: 500;
        }
        .abteilung-fax {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin: -10px 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .abteilung-header { font-size: 1.15rem; color: var(--text-main); margin: 0 0 15px 0; font-weight: 700; }

        .cards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(var(--card-min-width), 1fr)); gap: 20px; }

        .contact-card {
            background-color: var(--card-bg); border-left: 6px solid var(--accent);
            padding: 22px; border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .contact-card h4 { margin: 0 0 5px 0; font-size: 1.25rem; color: #000; }
        .job-position { color: #555; font-size: 0.85rem; font-weight: 600; margin-bottom: 15px; border-bottom: 1px solid #eeeeee; padding-bottom: 10px; }
        
        .contact-row { display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; }
        .icon-container { width: 18px; height: 18px; flex-shrink: 0; color: var(--accent); margin-top: 2px; }
        .contact-link { text-decoration: none; color: #000; font-size: 0.95rem; }

        /* --- AKZENT-MAPPING --- */
        .cat-01 { --accent: var(--hex-01); } .cat-02 { --accent: var(--hex-02); }
        .cat-03 { --accent: var(--hex-03); } .cat-04 { --accent: var(--hex-04); }
        .cat-05 { --accent: var(--hex-05); } .cat-06 { --accent: var(--hex-06); }
        .cat-07 { --accent: var(--hex-07); } .cat-08 { --accent: var(--hex-08); }
        .cat-09 { --accent: var(--hex-09); } .cat-10 { --accent: var(--hex-10); }
        .cat-11 { --accent: var(--hex-11); } .cat-12 { --accent: var(--hex-12); }
        .cat-13 { --accent: var(--hex-13); }

        .btn-icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2.2; }

        /* --- ACCESSIBILITY SIDEBAR STYLES --- */
        .acc-toggle-btn {
            position: fixed; bottom: 30px; right: 30px;
            width: 60px; height: 60px; border-radius: 50%;
            background-color: #2e7d32; color: white; border: none;
            cursor: pointer; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .acc-toggle-btn:hover { transform: scale(1.15); }
        .acc-toggle-btn svg { width: 34px; height: 34px; fill: white; }

        .acc-sidebar {
            position: fixed; top: 0; right: -360px; width: 340px; height: 100vh;
            z-index: 10000; transition: right 0.4s cubic-bezier(0.05, 0.74, 0.2, 0.99);
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px) saturate(160%);
            -webkit-backdrop-filter: blur(20px) saturate(160%);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: -10px 0 40px rgba(0,0,0,0.2);
            padding: 30px; display: flex; flex-direction: column; gap: 20px; color: #000;
        }
        [data-theme="dark"] .acc-sidebar { 
            background: rgba(20, 20, 20, 0.85); color: #fff; border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        .acc-sidebar.open { right: 0; }

        .acc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .close-acc { background: none; border: none; font-size: 2.5rem; cursor: pointer; color: inherit; line-height: 1; }

        .acc-section { display: flex; flex-direction: column; gap: 8px; }
        .acc-section label { font-weight: 800; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.7; }
        
        .acc-slider { 
            width: 100%; accent-color: #2e7d32; cursor: pointer; height: 25px; 
            background: transparent; -webkit-appearance: none;
        }
        .acc-slider::-webkit-slider-runnable-track { background: var(--border-ui); height: 6px; border-radius: 3px; }
        .acc-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; background: #2e7d32; border-radius: 50%; margin-top: -6px; }

        .theme-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .acc-btn {
            padding: 12px 8px; border: 1px solid var(--border-ui); border-radius: 10px;
            background: var(--bg-panel); color: var(--text-main); cursor: pointer;
            font-size: 0.8rem; font-weight: 700; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .acc-btn svg { width: 16px; height: 16px; stroke-width: 2.5; }
        .acc-btn:hover { border-color: #2e7d32; color: #2e7d32; transform: translateY(-2px); }
        .acc-btn.active { border: 2px solid #2e7d32; background: rgba(46, 125, 50, 0.15); color: #2e7d32; }

        .acc-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.2);
            display: none; z-index: 9998; /* Kein Blur hier! */
        }
        .acc-overlay.show { display: block; }

        @media print {
            /* Grundeinstellungen */
            @page {
                size: A4;
                margin: 0; /* Wir steuern die Abstände über die Sektionen */
            }

            body {
                background: white !important;
                color: black !important;
                font-size: 10pt;
            }

            .no-print, .acc-toggle-btn, .acc-sidebar, .acc-overlay, .update-hint {
                display: none !important;
            }

            #app-wrapper {
                padding: 0 !important;
                filter: none !important;
            }

            .print-only {
                display: block !important;
            }

            /* DECKBLATT STYLING */
            .print-cover {
                height: 100vh;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                align-items: center;
                text-align: center;
                page-break-after: always;
                padding: 2cm; /* Standard-Abstand für Druck */
                box-sizing: border-box;
            }

            .cover-header { margin-top: 5vh; }
            .cover-logo { height: 120px; width: auto; margin-bottom: 30px; filter: none !important; }
            .print-cover h1 { font-size: 42pt; font-weight: 900; text-transform: uppercase; margin: 0; color: #000; }
            .no-break { white-space: nowrap; }

            .toc-container { width: 100%; max-width: 17cm; margin: 40px auto; text-align: left; }
            .toc-title { font-weight: 900; font-size: 14pt; text-transform: uppercase; border-bottom: 3px solid #333; margin-bottom: 20px; padding-bottom: 5px; }
            .toc-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 11pt; }
            .toc-color-box { width: 14px; height: 14px; margin-right: 12px; border: 0.5pt solid #000; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .toc-dots { flex-grow: 1; border-bottom: 1px dotted #888; margin: 0 10px; position: relative; top: -4px; }
            .toc-page { font-weight: bold; min-width: 30px; text-align: right; }

            /* KORRIGIERTER FOOTER */
            .cover-footer {
                width: 100%;
                max-width: 17cm;
                border-top: 1pt solid #ccc;
                padding-top: 20px;
                display: flex !important; /* Flexbox erzwingen */
                justify-content: space-between !important;
                align-items: flex-start;
                font-size: 9pt;
                color: #555;
            }

            .cover-footer span:first-child {
                text-align: left;
                flex: 1;
            }

            #print-footer-info {
                text-align: right;
                line-height: 1.3; /* Optional: Zeilenabstand etwas verringern */
            }

            /* INHALTS-SEITEN STYLING */
            /* 1. Die gesamte Sektion bekommt den Hintergrund */
            .bereich-section {
                page-break-before: always;
                margin: 0 !important;
                padding: 2cm !important;
                min-height: 100vh; /* Sorgt dafür, dass die Farbe die ganze Seite füllt */
                border-radius: 0px;
                /* Hintergrundfarbe erzwingen (die helle Variante) */
                background-color: hsl(from var(--accent) h s l / var(--bg-opacity-area)) !important;
                
                /* Wichtig: Browser anweisen, Hintergründe zu drucken */
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }


            /* 2. Der Header bekommt den vollfarbigen Balken wie im Web */
            .bereich-header {
                background-color: var(--accent) !important;
                color: white !important;
                
                /* Den Header bis an die Ränder der Sektion ziehen */
                margin: -2cm -2cm 30px -2cm !important; 
                padding: 15px 2cm !important;
                font-size: 24pt !important;
                text-transform: uppercase;
                font-weight: 900;
                
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                margin-bottom: -2dvh !important; /* Verhindert zu großen Abstand nach unten */
            }
           
            .abteilung-group { padding-top: 4dvh; break-inside: avoid; }
            .abteilung-location {
                color: #333 !important;
                margin-bottom: 10px !important;
            }
            /* 3. Karten-Styling für bessere Lesbarkeit auf farbigem Grund */
            .contact-card {
                break-inside: avoid;
                border: none !important;
                background: white !important; /* Karten weiß lassen für Kontrast */
                box-shadow: 0 2mm 5mm rgba(0,0,0,0.1) !important;
                margin-bottom: 15px;
                padding: 15px !important;
            }

            /* 4. Sicherstellen, dass die Grid-Struktur im Druck passt */
            .cards-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important; /* 2 Spalten nutzen Platz besser */
                gap: 15px !important;
            }
            .contact-link { color: #000 !important; text-decoration: none; }
            .icon-container { color: var(--accent) !important; }
        } /* Hier schließt die Media Query korrekt */
    </style>
</head>
<body class="acc-default">

<!-- UI-Elemente außerhalb des gefilterten Wrappers -->
<div id="accOverlay" class="acc-overlay" onclick="toggleAccMenu()"></div>

<button class="acc-toggle-btn" onclick="toggleAccMenu()" aria-label="Barrierefreiheit Menü öffnen">
    <svg viewBox="0 0 24 24"><path d="M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm9 7h-6v13h-2v-6h-2v6H9V9H3V7h18v2z"/></svg>
</button>

<aside id="accSidebar" class="acc-sidebar" role="dialog" aria-labelledby="accTitle">
    <div class="acc-header">
        <h2 id="accTitle" style="margin:0; font-size: 1.1rem; font-weight: 900; text-transform: uppercase;">Barrierefreiheit</h2>
        <button class="close-acc" onclick="toggleAccMenu()" aria-label="Schließen">&times;</button>
    </div>

    <div class="acc-section">
        <label for="slider-font">Textgröße</label>
        <input type="range" id="slider-font" class="acc-slider" min="0.7" max="1.5" step="0.05" value="1">
    </div>

    <div class="acc-section">
        <label for="slider-line">Zeilenabstand</label>
        <input type="range" id="slider-line" class="acc-slider" min="1" max="2.2" step="0.1" value="1.5">
    </div>

    <div class="acc-section">
        <label for="slider-spacing">Zeichenabstand</label>
        <input type="range" id="slider-spacing" class="acc-slider" min="-0.5" max="5" step="0.5" value="0">
    </div>

    <hr style="width:100%; border: 0; border-top: 1px solid var(--border-ui); margin: 10px 0; opacity: 0.3;">

    <div class="acc-section">
        <label>Anzeige-Modus</label>
        <div class="theme-grid">
            <button class="acc-btn" onclick="setAccTheme('default')" id="btn-def">
                Standard
            </button>
            <button class="acc-btn" onclick="setAccTheme('grayscale')" id="btn-gray">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 2a10 10 0 0 0 0 20z" fill="currentColor"/></svg>
                Graustufen
            </button>
            <button class="acc-btn" onclick="setAccTheme('invert')" id="btn-inv">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/></svg>
                Invertiert
            </button>
            <button class="acc-btn" onclick="setAccTheme('high-contrast')" id="btn-high">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><path d="M12 6v12M6 12h12"/></svg>
                Kontrast
            </button>
        </div>
    </div>

    <button class="acc-btn" style="margin-top: auto; background: #d32f2f; color: white; border: none;" onclick="resetAcc()">
        Einstellungen zurücksetzen
    </button>
</aside>

<!-- Gesamter Seiteninhalt im Wrapper -->
<div id="app-wrapper">

    <div class="print-only">
        <div class="print-cover">
            <div class="cover-header">
                <img src="img/LHW Logo Trans.svg" alt="Logo" class="cover-logo">
                <div>
                    <h1>Kontaktverzeichnis</h1>
                    <p id="print-date" style="font-size: 14pt; color: #666; margin-top: 10px;">Datenstand: --</p>
                </div>
            </div>
            <div class="toc-container">
                <div class="toc-title">Farbleitsystem & Bereiche</div>
                <div id="print-toc"></div>
            </div>
            <div class="cover-footer">
                <span style="font-weight: 900; letter-spacing: 1px;">Lebenshilfswerk Waren gGmbH</span>
                <span id="print-footer-info"></span>
            </div>
        </div>
    </div>

    <header class="no-print">
        <div class="main-controls">
            <a href="https://lebenshilfswerk-waren.de" class="logo-link">
                <img src="img/LHW Logo Trans.svg" alt="LHW Logo" class="logo">
            </a>
            <div class="search-wrapper">
                <input type="text" id="search" onkeyup="handleSearch()" placeholder="Suchen nach Name, Bereich oder Abteilung...">
            </div>
        </div>
        <div class="action-controls">
            <button class="theme-btn" onclick="toggleTheme()" id="themeToggle">
                <svg id="sun-icon" class="btn-icon" style="display:none" viewBox="0 0 24 24"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>
                <svg id="moon-icon" class="btn-icon" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
                <span id="theme-text" style="margin-left: 8px">Dunkel</span>
            </button>
            <button onclick="window.print()" class="print-btn">
                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2m-12 0v5h12v-5m-12-4h12"/></svg>
                Drucken
            </button>
        </div>
    </header>

    <div id="last-update" class="update-hint"></div>
    <main id="directory"></main>

    <footer class="no-print web-footer">
        <div style="font-weight: 800;">Lebenshilfswerk Waren gGmbH</div>
        <div id="web-footer-info" style="text-align: right; line-height: 1.4;"></div>
    </footer>

</div> <!-- Ende app-wrapper -->

<script>
    /* --- KONFIGURATION & DATEN --- */
    const CONFIG_NAMES = {
        programmedBy: ["Dan Schneider"],
        maintainedBy: ["Simone Herzog", "Gordon Kempf"] // Jetzt 3 einzelne Einträge
    };
    const CSV_PATH = "data/kontakte.csv";
    const ICON_PHONE = `<svg class="btn-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07 19.5 19.5 0 01-6-6 19.79 19.79 0 01-3.07-8.67A2 2 0 014.11 2h3a2 2 0 012 1.72 12.84 12.84 0 00.7 2.81 2 2 0 01-.45 2.11L8.09 9.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45 12.84 12.84 0 002.81.7A2 2 0 0122 16.92z"/></svg>`;
    const ICON_MOBILE = `<svg class="btn-icon" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>`;
    const ICON_MAIL = `<svg class="btn-icon" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;
    const ICON_FAX = `<svg class="btn-icon" viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9l-7-7z"/><polyline points="13 2 13 9 20 9"/><line x1="6" y1="18" x2="18" y2="18"/><line x1="6" y1="14" x2="18" y2="14"/></svg>`;

    /* --- FOOTER SETUP --- */

    function setupFooters() {
        // Erstellt die Namenslisten mit Umbrüchen zwischen JEDEM Namen
        const maintainedList = CONFIG_NAMES.maintainedBy.join("<br>");
        const programmedList = CONFIG_NAMES.programmedBy.join("<br>");
        
        // HTML-Struktur: Label oben, Namen darunter
        const maintainedHtml = `<b>gewartet von:</b><br>${maintainedList}`;
        const programmedHtml = `<b>entwickelt von:</b><br>${programmedList}`;
        
        const finalContent = `${maintainedHtml}<br><br>${programmedHtml}`;

        // Web Footer
        const webFooter = document.getElementById('web-footer-info');
        if (webFooter) {
            webFooter.innerHTML = finalContent;
        }

        // Print Footer (Deckblatt)
        const printFooter = document.getElementById('print-footer-info');
        if (printFooter) {
            printFooter.innerHTML = finalContent;
        }
    }
    setupFooters();

    /* --- THEME LOGIK (HELL/DUNKEL) --- */
    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const isDark = theme === 'dark';
        document.getElementById('sun-icon').style.display = isDark ? 'block' : 'none';
        document.getElementById('moon-icon').style.display = isDark ? 'none' : 'block';
        document.getElementById('theme-text').textContent = isDark ? 'Hell' : 'Dunkel';
    }
    applyTheme(localStorage.getItem('dir-theme') || 'light');
    function toggleTheme() {
        const newTheme = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        localStorage.setItem('dir-theme', newTheme);
        applyTheme(newTheme);
    }

    /* --- ACCESSIBILITY LOGIK --- */
    const sidebar = document.getElementById('accSidebar');
    const overlay = document.getElementById('accOverlay');
    let accSettings = JSON.parse(localStorage.getItem('lhw-acc-settings')) || {
        fontSize: 1, lineHeight: 1.5, letterSpacing: 0, theme: 'default'
    };

    function toggleAccMenu() {
        sidebar.classList.toggle('open');
        overlay.classList.toggle('show');
    }

    function setAccTheme(theme) {
        accSettings.theme = theme;
        applyAccSettings();
    }

    function applyAccSettings() {
        // Skalierung über Root-Variable für echte dynamische Größe
        document.documentElement.style.setProperty('--acc-font-scale', accSettings.fontSize);
        document.body.style.lineHeight = accSettings.lineHeight;
        document.body.style.letterSpacing = accSettings.letterSpacing + "px";

        // Klassen auf Body setzen (für Filter-Mapping)
        document.body.classList.remove('acc-grayscale', 'acc-invert', 'acc-high-contrast', 'acc-default');
        document.body.classList.add('acc-' + accSettings.theme);

        // Buttons updaten
        document.querySelectorAll('.acc-btn').forEach(b => b.classList.remove('active'));
        const btnMap = { 'default': 'btn-def', 'grayscale': 'btn-gray', 'invert': 'btn-inv', 'high-contrast': 'btn-high' };
        document.getElementById(btnMap[accSettings.theme]).classList.add('active');

        localStorage.setItem('lhw-acc-settings', JSON.stringify(accSettings));
    }

    function resetAcc() {
        accSettings = { fontSize: 1, lineHeight: 1.5, letterSpacing: 0, theme: 'default' };
        document.getElementById('slider-font').value = 1;
        document.getElementById('slider-line').value = 1.5;
        document.getElementById('slider-spacing').value = 0;
        applyAccSettings();
    }

    document.getElementById('slider-font').addEventListener('input', e => { accSettings.fontSize = e.target.value; applyAccSettings(); });
    document.getElementById('slider-line').addEventListener('input', e => { accSettings.lineHeight = e.target.value; applyAccSettings(); });
    document.getElementById('slider-spacing').addEventListener('input', e => { accSettings.letterSpacing = e.target.value; applyAccSettings(); });

    window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && sidebar.classList.contains('open')) toggleAccMenu(); });

    /* --- DATEN-STAND --- */
    async function fetchLastModified() {
        try {
            const response = await fetch(CSV_PATH, { method: 'HEAD' });
            const lastMod = response.headers.get("Last-Modified");
            if (lastMod) {
                const date = new Date(lastMod);
                const dateStr = `Datenstand: ${date.toLocaleDateString('de-DE')}`;
                document.getElementById('last-update').textContent = dateStr;
                document.getElementById('print-date').textContent = dateStr;
            }
        } catch (e) {}
    }
    fetchLastModified();

    /* --- RENDERING --- */
    function handleSearch() {
        const query = document.getElementById('search').value.toLowerCase();
        
        document.querySelectorAll('.bereich-section').forEach(bereichSec => {
            const bereichHeader = bereichSec.querySelector('.bereich-header').textContent.toLowerCase();
            const bereichMatch = bereichHeader.includes(query);
            let bereichHasVisibleContent = false;

            bereichSec.querySelectorAll('.abteilung-group').forEach(abtGrp => {
                const abtHeaderEl = abtGrp.querySelector('.abteilung-header');
                const abtHeaderText = abtHeaderEl ? abtHeaderEl.textContent.toLowerCase() : "";
                const abtMatch = abtHeaderText.includes(query);
                let abtHasVisibleContent = false;

                abtGrp.querySelectorAll('.contact-card').forEach(card => {
                    // Eine Karte wird angezeigt, wenn:
                    // 1. Der Suchbegriff im Bereichs-Namen vorkommt
                    // 2. Der Suchbegriff im Abteilungs-Namen vorkommt
                    // 3. Der Suchbegriff in der Karte selbst (Name, Tel, Mail, etc.) vorkommt
                    const cardMatch = card.textContent.toLowerCase().includes(query);
                    const isVisible = bereichMatch || abtMatch || cardMatch;
                    
                    card.style.display = isVisible ? "" : "none";
                    if (isVisible) abtHasVisibleContent = true;
                });

                // Abteilung anzeigen, wenn der Header matcht ODER Karten darin sichtbar sind
                const showAbt = abtMatch || abtHasVisibleContent;
                abtGrp.style.display = showAbt ? "" : "none";
                if (showAbt) bereichHasVisibleContent = true;
            });

            // Sektion anzeigen, wenn Bereichs-Header matcht ODER Inhalte darin sichtbar sind
            bereichSec.style.display = (bereichMatch || bereichHasVisibleContent) ? "" : "none";
        });
    }

    Papa.parse(CSV_PATH, {
        download: true, header: true, skipEmptyLines: true,
        complete: (results) => {
            render(results.data);
            applyAccSettings(); // Nach Rendering Acc-Settings nochmal forcieren
        }
    });

    function render(data) {
        const root = document.getElementById('directory');
        const tocRoot = document.getElementById('print-toc');
        root.innerHTML = ""; tocRoot.innerHTML = "";

        const areaSortMap = {}; 
        const groupedData = data.reduce((acc, p) => {
            const b = p.Bereich?.trim() || "Allgemein";
            const a = p.Abteilung?.trim() || "_NO_DEPT_";
            const code = parseInt(p.ColorCode) || 99;
            if (!areaSortMap[b] || code < areaSortMap[b]) areaSortMap[b] = code;
            if (!acc[b]) acc[b] = {};
            if (!acc[b][a]) acc[b][a] = [];
            acc[b][a].push(p);
            return acc;
        }, {});

        const sortedBereiche = Object.keys(groupedData).sort((a, b) => areaSortMap[a] - areaSortMap[b]);

        sortedBereiche.forEach((bName, index) => {
            const sectionCode = areaSortMap[bName].toString().padStart(2, '0');
            const pageNum = index + 2;

            const tocItem = document.createElement('div');
            tocItem.className = 'toc-item';
            tocItem.innerHTML = `<div class="toc-color-box" style="background-color: var(--hex-${sectionCode})"></div><div class="toc-name">${bName}</div><div class="toc-dots"></div><div class="toc-page">S. ${pageNum}</div>`;
            tocRoot.appendChild(tocItem);

            const section = document.createElement('section');
            section.className = `bereich-section cat-${sectionCode}`;
            section.innerHTML = `<h2 class="bereich-header">${bName}</h2><div class="bereich-content"></div>`;
            const content = section.querySelector('.bereich-content');

            Object.keys(groupedData[bName]).sort().forEach(aName => {
                const group = document.createElement('div');
                group.className = "abteilung-group";
                
                const personArray = groupedData[bName][aName];
                const standort = personArray[0].Standort?.trim() || "";

                // FAX LOGIK: Häufigkeit zählen
                const faxList = personArray.map(p => p.Fax?.trim()).filter(f => f && f !== "-");
                let commonFax = "";
                if (faxList.length > 0) {
                    const counts = faxList.reduce((acc, f) => { acc[f] = (acc[f] || 0) + 1; return acc; }, {});
                    // Findet die Faxnummer, die am häufigsten vorkommt
                    commonFax = Object.keys(counts).reduce((a, b) => counts[a] >= counts[b] ? a : b);
                }

                let headerContent = "";
                if (aName !== "_NO_DEPT_") headerContent += `<h3 class="abteilung-header">${aName}</h3>`;
                if (standort && standort !== "-") headerContent += `<div class="abteilung-location">${standort}</div>`;
                
                // Fax im Header anzeigen (wenn vorhanden)
                if (commonFax) {
                    headerContent += `<div class="abteilung-fax">${ICON_FAX} Fax: ${commonFax}</div>`;
                }
                
                group.innerHTML = headerContent;

                const grid = document.createElement('div');
                grid.className = "cards-grid";

                personArray.sort((x,y) => x.Name.localeCompare(y.Name)).forEach(p => {
                    const card = document.createElement('div');
                    card.className = "contact-card";
                    
                    const row = (icon, val, type) => {
                        if (!val || val === "-") return "";
                        const link = type === 'tel' ? `tel:${val.replace(/\s/g, '')}` : `mailto:${val}`;
                        const displayVal = type === 'mail' ? val.replace('@', '@\u200B').split('-').join('\u2011') : val;
                        return `<div class="contact-row"><span class="icon-container">${icon}</span><a href="${link}" class="contact-link">${displayVal}</a></div>`;
                    };

                    // FAX IN DER CARD: Nur anzeigen, wenn sie von der Abteilungs-Fax abweicht
                    const individualFax = p.Fax?.trim();
                    const faxRow = (individualFax && individualFax !== "-" && individualFax !== commonFax) 
                        ? row(ICON_FAX, individualFax, 'tel') 
                        : "";

                    card.innerHTML = `
                        <h4>${p.Name}</h4>
                        <div class="job-position">${p.Position || ''}</div>
                        ${row(ICON_PHONE, p.Telefon, 'tel')}
                        ${row(ICON_MOBILE, p.Mobiltelefon, 'tel')}
                        ${row(ICON_MAIL, p.Email, 'mail')}
                        ${row(ICON_MAIL, p.Email_alt, 'mail')}
                        ${faxRow}
                    `;
                    
                    grid.appendChild(card);
                });
                group.appendChild(grid);
                content.appendChild(group);
            });
            root.appendChild(section);
        });
    }
</script>
</body>
</html>