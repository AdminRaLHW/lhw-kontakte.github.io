<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telefonverzeichnis | Phone Directory</title>
    
    <!-- External Library for CSV Parsing: PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        /* --- CSS VARIABLES & THEMING --- */
        :root {
            --accent-it: #1976d2;
            --bg-it: #e3f2fd;
            --accent-marketing: #7b1fa2;
            --bg-marketing: #f3e5f5;
            --accent-default: #455a64;
            --bg-default: #eceff1;
            --accent-01: #1976d2;
            --bg-01: #e3f2fd;
        }

        /* --- BASIC STYLING --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            color: #333; 
            background-color: #f9f9f9;
        }

        /* UI elements to hide during print */
        .no-print { 
            margin-bottom: 20px; 
            display: flex; 
            gap: 10px; 
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        input { 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            width: 300px; 
            font-size: 1rem;
        }

        .print-btn {
            padding: 10px 20px; 
            cursor: pointer;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .print-btn:hover {
            background-color: #f0f0f0;
        }

        /* --- GRID LAYOUT --- */
        #directory { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); 
            gap: 20px; 
        }

        /* Header for Department sections */
        .section-header { 
            grid-column: 1 / -1; 
            border-bottom: 2px solid #333; 
            margin-top: 40px;
            padding-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* --- CONTACT CARDS --- */
        .contact-card { 
            padding: 15px; 
            border-radius: 8px; 
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            border-left: 6px solid var(--accent-default);
            background: var(--bg-default);
        }

        .contact-card h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }

        .job-position {
            font-weight: 600;
            color: #555;
            margin: -5px 0 10px 0;
            font-size: 0.9rem;
        }

        /* Dynamic Category Colors */
        .cat-it { background: var(--bg-it); border-left-color: var(--accent-it); }
        .cat-01 { background: var(--bg-01); border-left-color: var(--accent-01); }
        .cat-marketing { background: var(--bg-marketing); border-left-color: var(--accent-marketing); }

        /* Icon & Data Alignment */
        .contact-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .icon-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            flex-shrink: 0;
        }

        /* --- PRINT STYLES --- */
        @media print {
            .no-print { display: none !important; }
            
            body { padding: 0; background: white; }

            .section-header { 
                break-before: page; 
                margin-top: 20px; 
                margin-bottom: 10px;
            }

            #directory {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr); /* Force 2 columns for A4 */
                gap: 15px;
                width: 100%;
            }

            .contact-card { 
                background: white !important; 
                border: 1px solid #ccc !important; 
                border-left: 5px solid #333 !important; 
                break-inside: avoid; 
                width: auto !important; 
                margin: 0 !important;
                box-shadow: none;
            }

            /* Maintain specific category colors during print if possible */
            .cat-marketing { border-left-color: var(--accent-marketing) !important; }
            .cat-it { border-left-color: var(--accent-it) !important; }
            .cat-01 { border-left-color: var(--accent-01) !important; }

            @page { 
                size: A4 portrait; 
                margin: 1.5cm; 
            }
        }
    </style>
</head>
<body>

<!-- UI Header: Search and Print -->
<div class="no-print">
    <input type="text" id="search" onkeyup="filter()" placeholder="Name, Abteilung oder Position suchen...">
    <button onclick="window.print()" class="print-btn">Drucken / PDF</button>
</div>

<!-- Container for generated cards -->
<div id="directory"></div>

<script>
    /* --- CONSTANTS: SVG Icons --- */
    const ICON_PHONE = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-accent"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>`;
    const ICON_MOBILE = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-accent"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>`;
    const ICON_MAIL = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon-accent"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>`;

    /**
     * Filters the contact cards based on search input
     */
    function filter() {
        let val = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('.contact-card').forEach(card => {
            // Check if card text content matches search term
            card.style.display = card.innerText.toLowerCase().includes(val) ? "" : "none";
        });
        
        // Hide/Show section headers based on visible cards
        // (Optional enhancement: hide headers if no cards are visible below them)
    }

    /**
     * Initialize CSV Parsing
     * Note: Make sure "data/kontakte.csv" exists relative to this file
     * or replace with a public URL.
     */
    Papa.parse("data/kontakte.csv", {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
            renderDirectory(results.data);
        },
        error: function(err) {
            console.error("Error loading CSV:", err);
            // Fallback instruction for user
            document.getElementById('directory').innerHTML = `<p style="color:red">CSV Datei nicht gefunden. Bitte stelle sicher, dass 'data/kontakte.csv' existiert.</p>`;
        }
    });

    /**
     * Renders the data into the HTML grid
     */
    function renderDirectory(data) {
        const container = document.getElementById('directory');
        container.innerHTML = ""; // Clear loader
        let lastDept = "";

        // 1. Filter out entries missing essential data
        const validData = data.filter(p => p.Abteilung && p.Name);

        // 2. Sort data by Department
        validData.sort((a, b) => (a.Abteilung || "").localeCompare(b.Abteilung || ""));

        // 3. Build DOM elements
        validData.forEach(p => {
            // Create Section Header if Department changes
            if(p.Abteilung !== lastDept) {
                lastDept = p.Abteilung;
                let h = document.createElement('h2'); 
                h.className = "section-header"; 
                h.innerText = lastDept;
                container.appendChild(h);
            }

            // Determine color class from CSV 'ColorCode' column
            let deptClass = p.ColorCode ? p.ColorCode.toLowerCase().replace(/\s/g, '') : 'default';
            let cls = "cat-" + deptClass;

            let div = document.createElement('div');
            div.className = `contact-card ${cls}`;
            
            // Helper function to only show rows with content
            const renderField = (icon, value) => {
                if (!value || value.trim() === "" || value === "-") return "";
                return `
                    <div class="contact-row">
                        <span class="icon-container">${icon}</span>
                        <span class="value-container">${value}</span>
                    </div>`;
            };

            // Construct Card HTML
            div.innerHTML = `
                <h3>${p.Name}</h3>
                ${p.Position ? `<p class="job-position">${p.Position}</p>` : ''}
                <div class="contact-info">
                    ${renderField(ICON_PHONE, p.Telefon)}
                    ${renderField(ICON_MOBILE, p.Mobiltelefon)}
                    ${renderField(ICON_MAIL, p.Email)}
                </div>
            `;
            
            container.appendChild(div);
        });
    }
</script>
</body>
</html>